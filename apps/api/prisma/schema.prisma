// Prisma Schema for Giglet
// Full schema implementation for Story 1.2

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
  binaryTargets   = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [postgis]
}

// ============ USERS ============

model User {
  id                  String       @id @default(cuid())
  email               String       @unique
  passwordHash        String?
  name                String?
  authProvider        AuthProvider @default(EMAIL)
  appleId             String?      @unique
  googleId            String?      @unique
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  deletionScheduledAt DateTime?    // Soft delete: null = active, set = pending deletion

  refreshTokens       RefreshToken[]
  passwordResetTokens PasswordResetToken[]
  platformAccounts    PlatformAccount[]
  deliveries       Delivery[]
  trips            Trip[]
  subscription     Subscription?
  preferences      UserPreferences?
  importBatches    ImportBatch[]
  tipLogs          TipLog[]
}

enum AuthProvider {
  EMAIL
  APPLE
  GOOGLE
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
}

model UserPreferences {
  id                    String  @id @default(cuid())
  userId                String  @unique
  user                  User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  notificationsEnabled  Boolean @default(true)
  zoneAlertsEnabled     Boolean @default(true)
  syncErrorAlertsEnabled Boolean @default(true)
  autoMileageTracking   Boolean @default(true)
  darkModeEnabled       Boolean @default(true)
}

// ============ PLATFORM ACCOUNTS ============

model PlatformAccount {
  id             String         @id @default(cuid())
  userId         String
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  platform       Platform
  encryptedCreds String // AES-256 encrypted
  status         PlatformStatus @default(CONNECTED)
  lastSyncAt     DateTime?
  lastSyncError  String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  deliveries Delivery[]

  @@unique([userId, platform])
  @@index([userId])
}

enum Platform {
  DOORDASH
  UBEREATS
}

enum PlatformStatus {
  CONNECTED
  SYNCING
  ERROR
  DISCONNECTED
}

// ============ EARNINGS ============

model ImportBatch {
  id             String   @id @default(cuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  platform       Platform
  filename       String
  importedCount  Int
  duplicateCount Int      @default(0)
  errorCount     Int      @default(0)
  createdAt      DateTime @default(now())

  deliveries Delivery[]

  @@index([userId, createdAt])
}

model Delivery {
  id                String           @id @default(cuid())
  userId            String
  user              User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  platformAccountId String?
  platformAccount   PlatformAccount? @relation(fields: [platformAccountId], references: [id], onDelete: Cascade)

  externalId String // Platform's delivery ID or generated hash
  platform   Platform

  earnings Decimal @db.Decimal(10, 2)
  tip      Decimal @db.Decimal(10, 2)
  basePay  Decimal @db.Decimal(10, 2)

  restaurantName String?
  deliveredAt    DateTime

  isManual      Boolean      @default(false)
  importBatchId String?
  importBatch   ImportBatch? @relation(fields: [importBatchId], references: [id])

  createdAt DateTime @default(now())

  @@unique([userId, externalId])
  @@index([userId, deliveredAt])
  @@index([userId, platform])
  @@index([platformAccountId])
}

// ============ MILEAGE ============

model Trip {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  startedAt DateTime
  endedAt   DateTime?
  miles     Decimal   @db.Decimal(10, 2)

  startLat Float
  startLng Float
  endLat   Float?
  endLng   Float?

  isManual Boolean @default(false)
  purpose  String  @default("Business - Delivery")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, startedAt])
}

// ============ SUBSCRIPTIONS ============

model Subscription {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  revenuecatId String             @unique
  tier         SubscriptionTier   @default(FREE)
  status       SubscriptionStatus @default(ACTIVE)

  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum SubscriptionTier {
  FREE
  PRO_MONTHLY
  PRO_ANNUAL
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELED
  GRACE_PERIOD
}

// ============ ZONES ============

model Zone {
  id      String  @id @default(cuid())
  h3Index String  @unique // H3 resolution 7 hex index
  name    String? // Human-readable name

  // Cached score components (refreshed every 15 min)
  restaurantDensity Float @default(0)
  restaurantRating  Float @default(0)

  // Current score (computed)
  currentScore Float @default(0)

  // PostGIS geometry for spatial queries
  geometry Unsupported("geometry(Polygon, 4326)")?

  lastCalculatedAt DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([h3Index])
  @@index([currentScore])
}

// ============ TIP TRACKING ============

enum TipSize {
  NONE
  SMALL
  MEDIUM
  LARGE
  XLARGE
  XXLARGE
}

model TipLog {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  lat       Float
  lng       Float
  tipSize   TipSize
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([lat, lng])
}
