<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>10</epicId>
    <storyId>3</storyId>
    <title>Tip Locations Map Layer</title>
    <status>ready-for-dev</status>
    <generatedAt>2026-01-06</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>.bmad-ephemeral/stories/10-3-tip-locations-map-layer.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>driver viewing the map</asA>
    <iWant>to see my logged tip locations as colored markers</iWant>
    <soThat>I can identify high-value tipping areas</soThat>
    <tasks>
      <task id="1" ac="1,3">Create TipMarker Component - colored marker with callout showing tip size, date, address</task>
      <task id="2" ac="1">Create Tips Toggle Control - button to show/hide tip markers layer</task>
      <task id="3" ac="4">Implement Viewport-Based Tip Loading - fetch tips on region change using getTipsInViewport</task>
      <task id="4" ac="2">Implement Marker Clustering - group nearby markers with count badge</task>
      <task id="5" ac="3">Add Reverse Geocoding for Callout - fetch address on marker tap with caching</task>
      <task id="6" ac="1-4">Integrate into MapPage - add tip markers layer to existing map</task>
      <task id="7" ac="1-4">Add Unit Tests</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">Given I have logged tips, When I toggle "My Tips" layer on the map, Then I see markers at my logged tip locations colored by tip size</criterion>
    <criterion id="2">Given I am viewing the map with tips layer enabled, When markers would overlap significantly at low zoom levels, Then they cluster with a count badge</criterion>
    <criterion id="3">Given I tap on a tip marker, When the callout appears, Then I see: tip size label, date logged, and address (reverse geocoded)</criterion>
    <criterion id="4">Given the tips layer is toggled on, When I pan/zoom the map, Then only tips within the visible viewport are loaded</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Story 10.3: Tip Locations Map Layer</section>
        <snippet>Toggle "My Tips" layer, colored markers by tip size, clustering at low zoom, reverse geocoding on tap.</snippet>
      </doc>
      <doc>
        <path>.bmad-ephemeral/stories/10-2-tip-location-storage-backend.md</path>
        <title>Story 10.2 - Predecessor</title>
        <section>Dev Agent Record</section>
        <snippet>Created getTipsInViewport() for viewport-based queries. getTipSizeColor() returns hex colors for markers.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>apps/mobile/app/(tabs)/index.tsx</path>
        <kind>page</kind>
        <symbol>MapPage</symbol>
        <lines>1-250</lines>
        <reason>EXTEND: Main map page with MapView, zone circles, tip logging FAB. Add tip markers layer here.</reason>
      </artifact>
      <artifact>
        <path>apps/mobile/src/services/tips.ts</path>
        <kind>service</kind>
        <symbol>getTipsInViewport, getTipSizeColor, getTipSizeLabel, TipLog</symbol>
        <lines>103-146</lines>
        <reason>REUSE: API functions and color mapping for markers. Already implemented in Story 10-2.</reason>
      </artifact>
      <artifact>
        <path>apps/mobile/src/components/tips/TipSizePicker.tsx</path>
        <kind>component</kind>
        <symbol>TipSizePicker</symbol>
        <reason>REFERENCE: Component pattern for tip-related UI from Story 10-1.</reason>
      </artifact>
      <artifact>
        <path>apps/mobile/src/components/tips/LogTipFAB.tsx</path>
        <kind>component</kind>
        <symbol>LogTipFAB</symbol>
        <reason>REFERENCE: FAB component pattern from Story 10-1.</reason>
      </artifact>
      <artifact>
        <path>apps/mobile/src/services/export.ts</path>
        <kind>service</kind>
        <symbol>reverseGeocode, addressCache</symbol>
        <lines>48-113</lines>
        <reason>REFERENCE: Address caching and reverse geocoding pattern to reuse for callout.</reason>
      </artifact>
    </code>

    <dependencies>
      <node>
        <package>react-native-maps</package>
        <version>^1.20.1</version>
        <use>MapView, Marker, Callout components for tip markers</use>
      </node>
      <node>
        <package>react-native-map-clustering</package>
        <version>^3.4.2</version>
        <use>Marker clustering at low zoom levels (may need to install)</use>
      </node>
      <node>
        <package>expo-location</package>
        <version>~18.0.10</version>
        <use>reverseGeocodeAsync for callout address</use>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Use existing MapView from app/(tabs)/index.tsx - don't replace the whole map</constraint>
    <constraint>Tip markers must coexist with zone circles without interference</constraint>
    <constraint>Debounce region change callbacks to avoid excessive API calls</constraint>
    <constraint>Only fetch tips when tips layer is toggled ON</constraint>
    <constraint>Reverse geocode ONLY on marker tap, not on render (saves API calls)</constraint>
    <constraint>Cache reverse geocoded addresses to avoid repeated lookups</constraint>
    <constraint>Color scheme must match getTipSizeColor() from tips.ts</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>TipMarker</name>
      <kind>React component</kind>
      <signature>TipMarker({ tip: TipLog, onPress: () => void })</signature>
      <path>apps/mobile/src/components/tips/TipMarker.tsx</path>
    </interface>
    <interface>
      <name>TipsToggle</name>
      <kind>React component</kind>
      <signature>TipsToggle({ enabled: boolean, onToggle: (enabled: boolean) => void })</signature>
      <path>apps/mobile/src/components/tips/TipsToggle.tsx</path>
    </interface>
    <interface>
      <name>getTipsInViewport</name>
      <kind>service function</kind>
      <signature>getTipsInViewport(bounds: ViewportBounds, options?: { tipSize?: TipSize; limit?: number }): Promise&lt;GetTipsResponse&gt;</signature>
      <path>apps/mobile/src/services/tips.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Use Vitest with vi.hoisted() pattern. Mock react-native-maps components. Test marker rendering and callout behavior.</standards>
    <locations>
      <location>apps/mobile/src/components/tips/__tests__/TipMarker.test.tsx</location>
    </locations>
    <ideas>
      <idea ac="1">Test TipMarker renders correct color for each tipSize using getTipSizeColor</idea>
      <idea ac="2">Test marker clustering groups nearby markers (may require integration test)</idea>
      <idea ac="3">Test callout shows loading state then address after reverse geocode</idea>
      <idea ac="4">Test tips are fetched when region changes and layer is enabled</idea>
      <idea ac="4">Test tips are NOT fetched when layer is disabled</idea>
    </ideas>
  </tests>
</story-context>
