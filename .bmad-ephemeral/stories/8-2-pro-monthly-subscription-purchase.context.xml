<story-context id="bmm/story-context" v="1.0">
  <metadata>
    <epicId>8</epicId>
    <storyId>2</storyId>
    <title>Pro Monthly Subscription Purchase</title>
    <status>drafted</status>
    <generatedAt>2026-01-04</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>.bmad-ephemeral/stories/8-2-pro-monthly-subscription-purchase.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>free user</asA>
    <iWant>subscribe to Pro monthly</iWant>
    <soThat>I can access all premium features immediately</soThat>
    <tasks>
      <task id="1" ac="1">Install and Configure RevenueCat SDK
        <subtask>Add react-native-purchases package to mobile app</subtask>
        <subtask>Configure RevenueCat API keys in environment (.env)</subtask>
        <subtask>Initialize RevenueCat in app/_layout.tsx on app startup</subtask>
        <subtask>Set up user identification with RevenueCat after login</subtask>
      </task>
      <task id="2" ac="1,2">Create Subscriptions Service
        <subtask>Create apps/mobile/src/services/subscriptions.ts</subtask>
        <subtask>Implement initializeRevenueCat() function</subtask>
        <subtask>Implement getOfferings() to fetch available products</subtask>
        <subtask>Implement purchasePackage(package) for purchase flow</subtask>
        <subtask>Handle purchase errors with user-friendly messages</subtask>
        <subtask>Implement getCustomerInfo() to check subscription status</subtask>
      </task>
      <task id="3" ac="1,2">Implement Purchase Flow in PaywallModal
        <subtask>Update PaywallModal.tsx handleUpgrade to call purchase flow</subtask>
        <subtask>Show loading state during purchase</subtask>
        <subtask>Handle success - close modal and refresh subscription store</subtask>
        <subtask>Handle cancellation - dismiss gracefully</subtask>
        <subtask>Handle errors - show error message with retry option</subtask>
      </task>
      <task id="4" ac="3">Create Backend Subscriptions Routes
        <subtask>Create apps/api/src/routes/subscriptions.routes.ts</subtask>
        <subtask>Create apps/api/src/controllers/subscriptions.controller.ts</subtask>
        <subtask>Create apps/api/src/services/subscriptions.service.ts</subtask>
        <subtask>Create apps/api/src/schemas/subscriptions.schema.ts</subtask>
        <subtask>Register routes in apps/api/src/routes/index.ts</subtask>
      </task>
      <task id="5" ac="3">Implement RevenueCat Webhook Handler
        <subtask>Create POST /api/v1/subscriptions/webhook endpoint</subtask>
        <subtask>Verify webhook signature with REVENUECAT_WEBHOOK_SECRET</subtask>
        <subtask>Handle INITIAL_PURCHASE event - create/update subscription</subtask>
        <subtask>Handle RENEWAL event - update subscription period</subtask>
        <subtask>Log all webhook events for debugging</subtask>
      </task>
      <task id="6" ac="4">Update Subscription Store on Purchase
        <subtask>Add refreshSubscription() action to subscriptionStore</subtask>
        <subtask>Call refresh after successful purchase</subtask>
        <subtask>Ensure Pro features unlock immediately without app restart</subtask>
      </task>
      <task id="7" ac="1,2,4">Test Purchase Flow
        <subtask>Test sandbox purchase on iOS</subtask>
        <subtask>Test sandbox purchase on Android</subtask>
        <subtask>Verify webhook delivery and subscription update</subtask>
        <subtask>Verify feature gates unlock after purchase</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">Given I am a free user, When I tap "Subscribe to Pro" or "Upgrade to Pro" button, Then I see pricing of $4.99/month, And I can complete purchase via App Store / Play Store, And on success Pro features unlock immediately, And I see confirmation of my subscription</criterion>
    <criterion id="2">Given purchase fails or is cancelled, When the error occurs, Then I see a user-friendly error message, And I can retry or dismiss the modal</criterion>
    <criterion id="3">Given I complete a purchase successfully, When the backend receives the RevenueCat webhook, Then my subscription record is created/updated with tier PRO_MONTHLY and status ACTIVE</criterion>
    <criterion id="4">Given I am a newly subscribed Pro user, When I tap previously locked features (Tax Export, Auto Mileage), Then they function without showing PaywallModal</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>.bmad-ephemeral/stories/tech-spec-epic-8.md</path>
        <title>Epic 8 Technical Specification</title>
        <section>Section 5-7</section>
        <snippet>RevenueCat SDK configuration, mobile and backend implementation patterns, webhook handling, product IDs (giglet_pro_monthly at $4.99/month)</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>System Architecture</title>
        <section>API Patterns</section>
        <snippet>Express route → controller → service pattern, Prisma ORM, Zod validation schemas</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Story 8.2</section>
        <snippet>Pro Monthly Subscription Purchase acceptance criteria and technical notes including RevenueCat SDK usage</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>apps/mobile/src/stores/subscriptionStore.ts</path>
        <kind>store</kind>
        <symbol>useSubscriptionStore</symbol>
        <lines>1-103</lines>
        <reason>Zustand store for subscription state - add refreshSubscription() action. Has tier, isProUser, loadSubscription, canAccess methods.</reason>
      </artifact>
      <artifact>
        <path>apps/mobile/src/components/subscriptions/PaywallModal.tsx</path>
        <kind>component</kind>
        <symbol>PaywallModal</symbol>
        <lines>1-287</lines>
        <reason>Modal with handleUpgrade placeholder (lines 53-58) - MUST implement purchase flow. Shows pricing cards for monthly/annual.</reason>
      </artifact>
      <artifact>
        <path>apps/mobile/src/hooks/useSubscription.ts</path>
        <kind>hook</kind>
        <symbol>useSubscription</symbol>
        <lines>1-105</lines>
        <reason>Convenience hook exposing canAccess, isProUser, tier. No changes needed.</reason>
      </artifact>
      <artifact>
        <path>apps/mobile/app/_layout.tsx</path>
        <kind>layout</kind>
        <symbol>RootLayout</symbol>
        <lines>1-17</lines>
        <reason>Root layout for RevenueCat initialization - add Purchases.configure() call on mount</reason>
      </artifact>
      <artifact>
        <path>apps/api/src/routes/index.ts</path>
        <kind>router</kind>
        <symbol>router</symbol>
        <lines>1-53</lines>
        <reason>API route registration - add subscriptionRoutes. Comment at line 49 shows placeholder.</reason>
      </artifact>
      <artifact>
        <path>apps/api/src/controllers/auth.controller.ts</path>
        <kind>controller</kind>
        <symbol>getMe</symbol>
        <lines>170-215</lines>
        <reason>Returns subscription info via /auth/me - verify webhook updates are reflected</reason>
      </artifact>
      <artifact>
        <path>apps/api/prisma/schema.prisma</path>
        <kind>schema</kind>
        <symbol>Subscription</symbol>
        <lines>184-211</lines>
        <reason>Subscription model with revenuecatId, tier, status, currentPeriodStart/End</reason>
      </artifact>
    </code>

    <dependencies>
      <mobile>
        <package name="react-native-purchases" version="TO_ADD" note="RevenueCat SDK - must install"/>
        <package name="zustand" version="^5.0.9"/>
        <package name="axios" version="^1.13.2"/>
        <package name="expo" version="~54.0.30"/>
        <package name="expo-router" version="^6.0.21"/>
      </mobile>
      <api>
        <package name="express" version="^5.2.1"/>
        <package name="@prisma/client" version="^6.19.1"/>
        <package name="zod" version="^4.3.4"/>
        <package name="jsonwebtoken" version="^9.0.3"/>
      </api>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint source="architecture">Follow Express route → controller → service pattern</constraint>
    <constraint source="architecture">Use Zod for request/response validation schemas</constraint>
    <constraint source="architecture">Use Prisma client for database operations</constraint>
    <constraint source="tech-spec">Use RevenueCat SDK for cross-platform IAP</constraint>
    <constraint source="tech-spec">Product ID: giglet_pro_monthly for monthly subscription</constraint>
    <constraint source="tech-spec">Entitlement name: pro</constraint>
    <constraint source="tech-spec">Verify webhook signature with REVENUECAT_WEBHOOK_SECRET</constraint>
    <constraint source="previous-story">Reuse subscriptionStore pattern from Story 8.1</constraint>
    <constraint source="previous-story">PaywallModal handleUpgrade is placeholder - implement actual flow</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>PaywallModalProps</name>
      <kind>component-props</kind>
      <signature>{ visible: boolean; onClose: () => void; feature?: string; onUpgrade?: () => void }</signature>
      <path>apps/mobile/src/components/subscriptions/PaywallModal.tsx</path>
    </interface>
    <interface>
      <name>SubscriptionState</name>
      <kind>store-interface</kind>
      <signature>{ tier: SubscriptionTier; isProUser: boolean; expiresAt: Date | null; loadSubscription: () => Promise&lt;void&gt;; canAccess: (feature: string) => boolean }</signature>
      <path>apps/mobile/src/stores/subscriptionStore.ts</path>
    </interface>
    <interface>
      <name>Subscription Model</name>
      <kind>prisma-model</kind>
      <signature>{ id, userId, revenuecatId, tier: SubscriptionTier, status: SubscriptionStatus, currentPeriodStart?, currentPeriodEnd? }</signature>
      <path>apps/api/prisma/schema.prisma:184-198</path>
    </interface>
    <interface>
      <name>POST /api/v1/subscriptions/webhook</name>
      <kind>REST endpoint</kind>
      <signature>Body: RevenueCat webhook payload; Response: 200 OK</signature>
      <path>apps/api/src/routes/subscriptions.routes.ts (TO CREATE)</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Use Vitest for both mobile and API tests. Follow existing test patterns in apps/api/src/services/__tests__/ for service tests. Mock external dependencies (RevenueCat SDK, Prisma). Test error scenarios and edge cases.</standards>
    <locations>
      <location>apps/api/src/services/__tests__/</location>
      <location>apps/mobile/src/services/__tests__/</location>
    </locations>
    <ideas>
      <idea ac="1">Test purchaseMonthly() returns true on successful purchase with mocked RevenueCat</idea>
      <idea ac="2">Test purchaseMonthly() throws user-friendly error on purchase failure</idea>
      <idea ac="2">Test purchaseMonthly() handles cancellation gracefully (no error thrown)</idea>
      <idea ac="3">Test webhook handler creates subscription on INITIAL_PURCHASE event</idea>
      <idea ac="3">Test webhook handler updates subscription on RENEWAL event</idea>
      <idea ac="3">Test webhook handler rejects invalid signature</idea>
      <idea ac="4">Test subscriptionStore.loadSubscription() updates isProUser after purchase</idea>
    </ideas>
  </tests>
</story-context>
