<story-context id="6-7-delivery-trip-correlation" v="1.0">
  <metadata>
    <epicId>6</epicId>
    <storyId>7</storyId>
    <title>Delivery-Trip Correlation</title>
    <status>drafted</status>
    <generatedAt>2026-01-03</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>.bmad-ephemeral/stories/6-7-delivery-trip-correlation.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>delivery driver with synced earnings and tracked trips</asA>
    <iWant>my trips automatically matched to my deliveries</iWant>
    <soThat>I have better documentation linking my mileage to specific work for tax purposes</soThat>
    <tasks>
      <task id="1" acs="1,2,3">
        Create Delivery Data Model for Local Storage
        <subtasks>
          <subtask>Define DeliveryRecord interface in deliveryStorage.ts</subtask>
          <subtask>Add storage functions: getDeliveries(), getDeliveriesByDateRange()</subtask>
          <subtask>Create mock delivery data for testing correlation logic</subtask>
        </subtasks>
      </task>
      <task id="2" acs="1,2,3">
        Implement Correlation Algorithm
        <subtasks>
          <subtask>Create correlateTripsWithDeliveries() function</subtask>
          <subtask>Match logic: delivery.deliveredAt BETWEEN trip.startedAt AND trip.endedAt</subtask>
          <subtask>Handle multi-drop: multiple deliveries can match single trip</subtask>
          <subtask>Return correlation result with trip ID to delivery IDs mapping</subtask>
          <subtask>Add tolerance window (+/-5 min) for edge cases</subtask>
        </subtasks>
      </task>
      <task id="3" acs="1,4">
        Update Trip List to Show Delivery Icon
        <subtasks>
          <subtask>Modify TripListItem.tsx to accept hasLinkedDeliveries prop</subtask>
          <subtask>Add delivery icon (shopping bag) when trip has matches</subtask>
          <subtask>Show delivery count badge if multiple deliveries</subtask>
          <subtask>Style: use cyan accent color (#06B6D4)</subtask>
        </subtasks>
      </task>
      <task id="4" acs="2,3,4">
        Update Trip Detail Modal with Delivery Info
        <subtasks>
          <subtask>Add "Linked Deliveries" section to TripDetailModal.tsx</subtask>
          <subtask>Display for each matched delivery: platform icon, restaurant name, earnings, time</subtask>
          <subtask>Show "No linked deliveries" message when none matched</subtask>
          <subtask>Style delivery cards consistent with dark theme</subtask>
        </subtasks>
      </task>
      <task id="5" acs="1,2,3">
        Integrate Correlation on Trip Load
        <subtasks>
          <subtask>Call correlation logic when loading trip history</subtask>
          <subtask>Store correlation results in mileage store or compute on demand</subtask>
          <subtask>Update getPaginatedTrips() to include correlation data</subtask>
          <subtask>Ensure performance with large datasets (lazy evaluation)</subtask>
        </subtasks>
      </task>
      <task id="6" acs="1,2,3,4">
        Add Unit Tests
        <subtasks>
          <subtask>Test correlateTripsWithDeliveries() with various scenarios</subtask>
          <subtask>Test single delivery matching single trip</subtask>
          <subtask>Test multiple deliveries matching single trip (multi-drop)</subtask>
          <subtask>Test no matches scenario</subtask>
          <subtask>Test edge cases (delivery at exact trip start/end time)</subtask>
          <subtask>Test tolerance window behavior</subtask>
        </subtasks>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">Given I have synced deliveries and tracked trips, When a delivery's timestamp falls within a trip's start/end time, Then the trip shows a matched delivery icon in the trip list</criterion>
    <criterion id="2">Given a trip matches one or more deliveries, When I view the trip details, Then I see the linked delivery info (platform, restaurant, earnings, time)</criterion>
    <criterion id="3">Given a trip has multiple deliveries (multi-drop), When I view trip details, Then all matched deliveries are listed</criterion>
    <criterion id="4">Given a trip has no matching deliveries, When I view the trip, Then no delivery icon is shown and details say "No linked deliveries"</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Epic 6: Automatic Mileage Tracking, Story 6.7</section>
        <snippet>Story 6.7 specifies matching trips to deliveries by timestamp proximity, with full functionality requiring Epic 3 (Earnings Import) for real delivery data.</snippet>
      </doc>
      <doc>
        <path>.bmad-ephemeral/stories/tech-spec-epic-6.md</path>
        <title>Epic 6 Technical Specification</title>
        <section>Acceptance Criteria 18, 19</section>
        <snippet>AC 18: Given synced deliveries and trips, when times overlap, trips show matched delivery icon. AC 19: Given trip matches delivery, when viewing trip details, see linked delivery info.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>Data Models, Project Structure</section>
        <snippet>Defines Delivery model in Prisma schema, mileage components structure, and Zustand store patterns for state management.</snippet>
      </doc>
    </docs>

    <code>
      <file>
        <path>apps/mobile/src/components/TripListItem.tsx</path>
        <kind>component</kind>
        <symbol>TripListItem</symbol>
        <lines>1-137</lines>
        <reason>Component to modify - add hasLinkedDeliveries prop and delivery indicator icon with count badge</reason>
      </file>
      <file>
        <path>apps/mobile/src/components/TripDetailModal.tsx</path>
        <kind>component</kind>
        <symbol>TripDetailModal</symbol>
        <lines>1-900</lines>
        <reason>Component to modify - add LinkedDeliveriesSection below stats section with delivery cards</reason>
      </file>
      <file>
        <path>apps/mobile/src/utils/locationStorage.ts</path>
        <kind>utility</kind>
        <symbol>locationStorage</symbol>
        <lines>1-503</lines>
        <reason>Contains trip CRUD operations, pagination, CompletedTrip interface - correlation functions should follow same patterns</reason>
      </file>
      <file>
        <path>apps/mobile/src/services/locationTracking.ts</path>
        <kind>service</kind>
        <symbol>CompletedTrip</symbol>
        <lines>52-65</lines>
        <reason>Defines CompletedTrip interface with startedAt/endedAt fields used for correlation matching</reason>
      </file>
      <file>
        <path>apps/mobile/src/stores/mileageStore.ts</path>
        <kind>store</kind>
        <symbol>useMileageStore</symbol>
        <lines>1-379</lines>
        <reason>Zustand store for mileage state - may need to add correlation data or compute on demand</reason>
      </file>
      <file>
        <path>apps/mobile/app/(tabs)/mileage.tsx</path>
        <kind>screen</kind>
        <symbol>MileageScreen</symbol>
        <reason>Main mileage tab - wire up correlation when loading trips</reason>
      </file>
      <file>
        <path>apps/mobile/app/trip-history.tsx</path>
        <kind>screen</kind>
        <symbol>TripHistoryScreen</symbol>
        <reason>Trip history screen - needs to pass correlation data to TripListItem components</reason>
      </file>
    </code>

    <dependencies>
      <node>
        <package>@react-native-async-storage/async-storage</package>
        <version>2.2.0</version>
        <purpose>Local storage for delivery data and correlation results</purpose>
      </node>
      <package>zustand</package>
        <version>^5.0.9</version>
        <purpose>State management for mileage and potentially correlation data</purpose>
      <package>@expo/vector-icons</package>
        <version>^15.0.3</version>
        <purpose>Ionicons for delivery indicator icon (shopping-bag)</purpose>
      <package>vitest</package>
        <version>^4.0.16</version>
        <purpose>Testing framework for unit tests</purpose>
    </dependencies>
  </artifacts>

  <interfaces>
    <interface>
      <name>DeliveryRecord</name>
      <kind>TypeScript interface</kind>
      <signature>
interface DeliveryRecord {
  id: string;
  platform: 'DOORDASH' | 'UBEREATS';
  restaurantName: string;
  deliveredAt: Date;
  earnings: number;  // total (base + tip)
  tip: number;
  basePay: number;
  isManual: boolean;
}
      </signature>
      <path>apps/mobile/src/utils/deliveryStorage.ts (new)</path>
    </interface>
    <interface>
      <name>CorrelationResult</name>
      <kind>TypeScript interface</kind>
      <signature>
interface CorrelationResult {
  tripId: string;
  deliveryIds: string[];
  deliveryCount: number;
}
      </signature>
      <path>apps/mobile/src/utils/deliveryStorage.ts (new)</path>
    </interface>
    <interface>
      <name>correlateTripsWithDeliveries</name>
      <kind>function signature</kind>
      <signature>
function correlateTripsWithDeliveries(
  trips: CompletedTrip[],
  deliveries: DeliveryRecord[],
  toleranceMs?: number
): Map&lt;string, CorrelationResult&gt;
      </signature>
      <path>apps/mobile/src/utils/deliveryStorage.ts (new)</path>
    </interface>
    <interface>
      <name>CompletedTrip</name>
      <kind>TypeScript interface (existing)</kind>
      <signature>
interface CompletedTrip {
  id: string;
  startedAt: string;
  endedAt: string;
  miles: number;
  startLat: number;
  startLng: number;
  endLat: number;
  endLng: number;
  pointCount: number;
  isManual: boolean;
  encodedRoute?: string;
}
      </signature>
      <path>apps/mobile/src/services/locationTracking.ts</path>
    </interface>
  </interfaces>

  <constraints>
    <constraint type="pattern">Follow existing locationStorage.ts patterns for new deliveryStorage.ts functions</constraint>
    <constraint type="pattern">Use AsyncStorage with @giglet/ prefix for storage keys</constraint>
    <constraint type="styling">Dark theme colors: #09090B (bg), #18181B (card), #27272A (border), #06B6D4 (cyan), #22C55E (green)</constraint>
    <constraint type="architecture">Correlation logic should be pure functions for easy testing</constraint>
    <constraint type="performance">Lazy evaluation for large datasets - compute correlation on demand, not on every trip load</constraint>
    <constraint type="dependency">Epic 3 (Earnings Import) not implemented - use mock delivery data for development and testing</constraint>
    <constraint type="testing">Use Vitest with vi.mock for AsyncStorage, vi.useFakeTimers for date testing</constraint>
    <constraint type="platform">Platform icons: DoorDash (red/white), Uber Eats (green/black) for visual identification</constraint>
  </constraints>

  <tests>
    <standards>
      Testing uses Vitest framework with vi.mock() for AsyncStorage and vi.useFakeTimers() for date-dependent tests. Tests are located in __tests__ folders adjacent to source files. Mock data patterns established in locationStorage.test.ts. Currently 111+ tests passing across the mobile app. Test files follow naming convention: *.test.ts
    </standards>
    <locations>
      <location>apps/mobile/src/utils/__tests__/</location>
      <location>apps/mobile/src/services/__tests__/</location>
      <location>apps/mobile/src/constants/__tests__/</location>
    </locations>
    <ideas>
      <idea ac="1">Test correlateTripsWithDeliveries() returns correct matches when delivery.deliveredAt falls within trip time range</idea>
      <idea ac="1">Test that tolerance window (+/- 5 min) correctly expands matching range</idea>
      <idea ac="2">Test that matched deliveries include platform, restaurant, earnings, time fields</idea>
      <idea ac="3">Test multi-drop scenario: single trip with 3+ deliveries all within time range</idea>
      <idea ac="4">Test no-match scenario: trip with no deliveries in time range returns empty deliveryIds array</idea>
      <idea ac="1,4">Test edge case: delivery at exact trip.startedAt or trip.endedAt boundary</idea>
      <idea ac="1">Test with empty deliveries array returns no matches</idea>
      <idea ac="1">Test with empty trips array returns empty Map</idea>
    </ideas>
  </tests>
</story-context>
