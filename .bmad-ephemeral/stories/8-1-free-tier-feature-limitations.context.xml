<story-context id="bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>8</epicId>
    <storyId>1</storyId>
    <title>Free Tier Feature Limitations</title>
    <status>drafted</status>
    <generatedAt>2026-01-04</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>.bmad-ephemeral/stories/8-1-free-tier-feature-limitations.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>free user</asA>
    <iWant>to understand what features require Pro</iWant>
    <soThat>I can decide whether to upgrade</soThat>
    <tasks>
      <task id="1" ac="4">Create Subscription Store
        <subtask>Create apps/mobile/src/stores/subscriptionStore.ts</subtask>
        <subtask>Define SubscriptionTier enum (FREE, PRO_MONTHLY, PRO_ANNUAL)</subtask>
        <subtask>Implement currentTier, isProUser, expiresAt state</subtask>
        <subtask>Add loadSubscription action (fetch from API)</subtask>
        <subtask>Add checkFeatureAccess method for gating</subtask>
      </task>
      <task id="2" ac="1,3">Create useSubscription Hook
        <subtask>Create apps/mobile/src/hooks/useSubscription.ts</subtask>
        <subtask>Expose isProUser, tier, canAccess(feature) helpers</subtask>
        <subtask>Define PRO_FEATURES constant array</subtask>
      </task>
      <task id="3" ac="1,3">Create PaywallModal Component
        <subtask>Create apps/mobile/src/components/subscriptions/PaywallModal.tsx</subtask>
        <subtask>Display locked feature explanation</subtask>
        <subtask>Show Pro benefits list</subtask>
        <subtask>Show pricing options (monthly/annual with savings badge)</subtask>
        <subtask>Add "Upgrade to Pro" button (placeholder for Story 8.2)</subtask>
        <subtask>Add "Maybe Later" dismiss option</subtask>
      </task>
      <task id="4" ac="1,2">Add Pro Gates to Dashboard
        <subtask>Import useSubscription hook in dashboard.tsx</subtask>
        <subtask>Gate Tax Export card - show lock icon and "Upgrade to Pro" for free users</subtask>
        <subtask>Show PaywallModal when locked feature tapped</subtask>
      </task>
      <task id="5" ac="1,2">Add Pro Gate to Mileage Auto-Tracking
        <subtask>Gate auto-tracking toggle in mileage.tsx for free users</subtask>
        <subtask>Allow manual trip entry for all users</subtask>
        <subtask>Show PaywallModal when auto-tracking toggle attempted by free user</subtask>
      </task>
      <task id="6" ac="4">Add Subscription Status to Backend User Response
        <subtask>Ensure GET /api/v1/auth/me returns subscription tier</subtask>
        <subtask>Verify Subscription model relation in User query</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">Given I am a free user, When I try to access a Pro feature (auto mileage tracking, tax export, unlimited history), Then I see the feature is locked with a clear explanation of what Pro unlocks and an "Upgrade to Pro" button</criterion>
    <criterion id="2">Given I am on the free tier, When I use the app, Then I can view Focus Zones map (free), manually enter mileage, and see 7 days of history</criterion>
    <criterion id="3">Given I am a free user, When I tap a locked Pro feature, Then I see a PaywallModal explaining Pro benefits with monthly ($4.99) and annual ($34.99) pricing options</criterion>
    <criterion id="4">Given subscription state changes, When the app refreshes, Then the subscription store reflects the current tier and feature access updates accordingly</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/architecture.md" title="Architecture" section="Subscriptions">
        Defines RevenueCat for cross-platform IAP, Subscription model with tier/status enums, and subscriptions.routes.ts for API endpoints.
      </doc>
      <doc path="docs/PRD.md" title="Product Requirements" section="FR-7: Subscription Management">
        Free tier: Focus Zones viewable, sync/mileage/export locked. Pro: $4.99/month or $34.99/year. Clear upgrade prompts required.
      </doc>
      <doc path=".bmad-ephemeral/stories/tech-spec-epic-8.md" title="Epic 8 Tech Spec" section="Story 8.1">
        Detailed implementation: subscriptionStore.ts, PaywallModal.tsx, useSubscription.ts hook, feature gating logic with PRO_FEATURES array.
      </doc>
      <doc path="docs/epics.md" title="Epics" section="Epic 8: Story 8.1">
        Free tier: Focus Zones (view only), manual mileage, 7-day history. Pro tier: Auto sync, auto mileage, unlimited history, tax export, alerts.
      </doc>
    </docs>
    <code>
      <file path="apps/mobile/src/stores/authStore.ts" kind="store" reason="Reference pattern for Zustand store structure with state, actions, async operations">
        <symbol>useAuthStore</symbol>
        <lines>1-141</lines>
      </file>
      <file path="apps/mobile/app/(tabs)/dashboard.tsx" kind="screen" reason="Contains Tax Export card that needs Pro gate - already has proBadge styling at lines 265-281, 519-528">
        <symbol>DashboardPage</symbol>
        <lines>265-282</lines>
      </file>
      <file path="apps/mobile/app/(tabs)/mileage.tsx" kind="screen" reason="Contains auto-tracking toggle that needs Pro gate - trackingEnabled state at line 16">
        <symbol>MileagePage</symbol>
        <lines>14-17, 172-175</lines>
      </file>
      <file path="apps/api/prisma/schema.prisma" kind="schema" reason="Subscription model with tier enum (FREE, PRO_MONTHLY, PRO_ANNUAL) and status enum">
        <symbol>Subscription, SubscriptionTier, SubscriptionStatus</symbol>
        <lines>184-211</lines>
      </file>
      <file path="apps/mobile/src/services/api.ts" kind="service" reason="API client for backend calls - subscription fetch will use this pattern">
        <symbol>api</symbol>
      </file>
    </code>
    <dependencies>
      <node>
        <package name="zustand" version="^5.0.9" reason="State management for subscriptionStore"/>
        <package name="expo-secure-store" version="~15.0.8" reason="Secure token storage pattern"/>
        <package name="axios" version="^1.13.2" reason="API calls"/>
        <package name="react-native" version="0.81.5" reason="Core framework"/>
        <package name="expo-router" version="^6.0.21" reason="Navigation"/>
      </node>
      <note>RevenueCat (react-native-purchases) not yet installed - will be added in Story 8.2</note>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="pattern">Follow Zustand store pattern from authStore.ts - state interface, create(), actions</constraint>
    <constraint type="pattern">Use existing dark theme colors: #09090B (bg), #18181B (card), #27272A (border), #06B6D4 (primary), #22C55E (success)</constraint>
    <constraint type="pattern">Modal styling follows existing patterns in mileage.tsx (modalOverlay, modalContent)</constraint>
    <constraint type="layer">Store → Hook → Component hierarchy for subscription access</constraint>
    <constraint type="feature">PRO_FEATURES array defines gated features: autoMileageTracking, taxExport, unlimitedHistory, zoneAlerts</constraint>
    <constraint type="ux">Tax Export card already shows "Pro" badge and lock icon - enhance with PaywallModal on tap</constraint>
    <constraint type="ux">Free users can still use manual mileage entry - only auto-tracking is Pro-gated</constraint>
  </constraints>

  <interfaces>
    <interface name="SubscriptionState" kind="typescript interface" path="apps/mobile/src/stores/subscriptionStore.ts">
      interface SubscriptionState {
        tier: 'FREE' | 'PRO_MONTHLY' | 'PRO_ANNUAL';
        isProUser: boolean;
        expiresAt: Date | null;
        isLoading: boolean;
        loadSubscription: () => Promise&lt;void&gt;;
        canAccess: (feature: string) => boolean;
      }
    </interface>
    <interface name="GET /api/v1/auth/me" kind="REST endpoint" path="apps/api/src/routes/auth.routes.ts">
      Response should include subscription.tier field for client-side feature gating
    </interface>
    <interface name="PaywallModalProps" kind="component props" path="apps/mobile/src/components/subscriptions/PaywallModal.tsx">
      interface PaywallModalProps {
        visible: boolean;
        onClose: () => void;
        feature: string;
        onUpgrade?: () => void;
      }
    </interface>
  </interfaces>

  <tests>
    <standards>
      Mobile uses Vitest for testing. Tests are colocated in __tests__ directories alongside source files.
      Pattern: src/services/__tests__/service.test.ts
      Run with: npm test (vitest run)
    </standards>
    <locations>
      <location>apps/mobile/src/stores/__tests__/</location>
      <location>apps/mobile/src/hooks/__tests__/</location>
      <location>apps/mobile/src/components/subscriptions/__tests__/</location>
    </locations>
    <ideas>
      <idea ac="1,3">Test PaywallModal renders with feature name, benefits, pricing, and buttons</idea>
      <idea ac="4">Test subscriptionStore.canAccess returns false for PRO_FEATURES when tier is FREE</idea>
      <idea ac="4">Test subscriptionStore.canAccess returns true for all features when tier is PRO_MONTHLY or PRO_ANNUAL</idea>
      <idea ac="4">Test loadSubscription fetches from API and updates state</idea>
      <idea ac="2">Test useSubscription hook exposes isProUser correctly based on tier</idea>
    </ideas>
  </tests>
</story-context>
