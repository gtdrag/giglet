<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>8</epicId>
    <storyId>4</storyId>
    <title>Subscription Status Display</title>
    <status>drafted</status>
    <generatedAt>2026-01-04</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>.bmad-ephemeral/stories/8-4-subscription-status-display.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Pro user</asA>
    <iWant>to see my subscription status</iWant>
    <soThat>I know my plan and renewal date</soThat>
    <tasks>
      <task id="1" acs="1,2,3">Create Subscription Management Screen
        <subtask>Create apps/mobile/app/subscription.tsx screen</subtask>
        <subtask>Display current tier (FREE/PRO_MONTHLY/PRO_ANNUAL) with user-friendly labels</subtask>
        <subtask>Display renewal/expiration date for Pro subscribers</subtask>
        <subtask>Display "days remaining" calculation for Pro subscribers</subtask>
        <subtask>Add "Manage Subscription" button with platform-specific deep link</subtask>
        <subtask>Show upgrade prompt for Free users with link to PaywallModal</subtask>
      </task>
      <task id="2" acs="2">Implement Platform Subscription Management Deep Links
        <subtask>Add getManagementUrl() function to subscriptions.ts</subtask>
        <subtask>Implement iOS App Store subscription management URL</subtask>
        <subtask>Implement Android Play Store subscription management URL</subtask>
        <subtask>Handle platform detection and appropriate URL opening</subtask>
      </task>
      <task id="3" acs="4">Update Accounts Screen
        <subtask>Add subscription tier display to Accounts screen</subtask>
        <subtask>Add navigation link to subscription management screen</subtask>
        <subtask>Show Pro badge for Pro subscribers</subtask>
      </task>
      <task id="4" acs="1,3">Write Unit Tests
        <subtask>Test subscription screen renders correctly for each tier</subtask>
        <subtask>Test management URL generation</subtask>
        <subtask>Test navigation from Accounts to subscription screen</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <ac id="1">Given I am a Pro subscriber, When I view Settings > Subscription (or tap subscription link on Accounts screen), Then I see my current tier ("Pro Monthly" or "Pro Annual"), And I see my renewal date, And I see a "Manage Subscription" button</ac>
    <ac id="2">Given I tap "Manage Subscription", When the action completes, Then I am taken to the App Store (iOS) or Play Store (Android) subscription management page</ac>
    <ac id="3">Given I am a Free user, When I view the subscription screen, Then I see my current status as "Free", And I see a prompt to upgrade with a link to the paywall</ac>
    <ac id="4">Given I am on the Accounts screen, When I view my profile section, Then I see my subscription tier displayed (Free/Pro Monthly/Pro Annual), And I can tap to navigate to the subscription management screen</ac>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path=".bmad-ephemeral/stories/tech-spec-epic-8.md" title="Epic 8 Tech Spec" section="Story 8.4">
        Story 8.4 implementation: Create subscription management UI in settings, add management URL deep links. Files to create: subscription.tsx. Files to modify: accounts.tsx.
      </doc>
      <doc path="docs/epics.md" title="Epics" section="Story 8.4">
        As a Pro user, I want to see my subscription status, so that I know my plan and renewal date. Manage Subscription link should open App Store / Play Store.
      </doc>
      <doc path=".bmad-ephemeral/stories/tech-spec-epic-8.md" title="Epic 8 Tech Spec" section="Section 4.1">
        GET /api/v1/subscriptions returns tier, status, currentPeriodStart, currentPeriodEnd, willRenew, managementUrl.
      </doc>
    </docs>
    <code>
      <file path="apps/mobile/src/stores/subscriptionStore.ts" kind="store" symbol="useSubscriptionStore" reason="Provides tier, isProUser, expiresAt state. Use for displaying subscription status.">
        <interface>tier: SubscriptionTier, isProUser: boolean, expiresAt: Date | null, loadSubscription(), canAccess(feature), setTier(tier)</interface>
      </file>
      <file path="apps/mobile/src/services/subscriptions.ts" kind="service" symbol="subscriptions" reason="RevenueCat wrapper. Add getManagementUrl() here. Has restorePurchases(), getSubscriptionDetails().">
        <interface>initializeRevenueCat(), identifyUser(userId), purchaseMonthly(), purchaseAnnual(), restorePurchases(), getSubscriptionDetails(customerInfo), isSubscriptionServiceAvailable()</interface>
      </file>
      <file path="apps/mobile/app/accounts.tsx" kind="screen" symbol="AccountsScreen" reason="Modify to add subscription tier display and navigation link to subscription screen.">
        <interface>Existing screen with platform connections and sign out. Add subscription section above sign out.</interface>
      </file>
      <file path="apps/mobile/src/components/subscriptions/PaywallModal.tsx" kind="component" symbol="PaywallModal" reason="Reference for upgrade UI. Free users should be able to navigate to this from subscription screen."/>
      <file path="apps/mobile/src/stores/__tests__/subscriptionStore.test.ts" kind="test" symbol="subscriptionStore tests" lines="1-239" reason="Testing patterns for subscription store. Use vi.mock and direct store access patterns."/>
    </code>
    <dependencies>
      <node>
        <pkg name="react-native-purchases" version="^9.6.13">RevenueCat SDK for IAP</pkg>
        <pkg name="zustand" version="^5.0.9">State management for subscription store</pkg>
        <pkg name="expo-router" version="^6.0.21">Navigation framework</pkg>
        <pkg name="expo-linking" version="^8.0.11">For opening external URLs (management URLs)</pkg>
        <pkg name="vitest" version="^4.0.16">Testing framework</pkg>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="pattern">Use Zustand store pattern for state management (see subscriptionStore.ts)</constraint>
    <constraint type="pattern">Use expo-router for navigation (router.push, router.back)</constraint>
    <constraint type="pattern">Follow existing screen style patterns from accounts.tsx (SafeAreaView, header, content structure)</constraint>
    <constraint type="pattern">Use Ionicons for icons (from @expo/vector-icons)</constraint>
    <constraint type="pattern">Use Platform.OS for platform detection (ios vs android)</constraint>
    <constraint type="testing">Use Vitest with vi.mock for mocking, vi.hoisted() for module-level mocks</constraint>
    <constraint type="style">Dark theme: backgroundColor #09090B, text #FAFAFA, muted #A1A1AA, accent #10b981</constraint>
  </constraints>

  <interfaces>
    <interface name="SubscriptionTier" kind="type" path="apps/mobile/src/stores/subscriptionStore.ts">
      type SubscriptionTier = 'FREE' | 'PRO_MONTHLY' | 'PRO_ANNUAL'
    </interface>
    <interface name="useSubscriptionStore" kind="zustand-store" path="apps/mobile/src/stores/subscriptionStore.ts">
      { tier: SubscriptionTier, isProUser: boolean, expiresAt: Date | null, loadSubscription(), canAccess(feature), setTier(tier) }
    </interface>
    <interface name="getManagementUrl" kind="function" path="apps/mobile/src/services/subscriptions.ts">
      TO BE CREATED: () => string - Returns platform-specific subscription management URL
    </interface>
    <interface name="iOS Management URL" kind="url">
      itms-apps://apps.apple.com/account/subscriptions OR https://apps.apple.com/account/subscriptions
    </interface>
    <interface name="Android Management URL" kind="url">
      https://play.google.com/store/account/subscriptions
    </interface>
  </interfaces>

  <tests>
    <standards>
      Use Vitest for all unit tests. Use vi.mock() for mocking modules, vi.hoisted() for mock function initialization before hoisting. For Zustand stores, test using direct store access (useSubscriptionStore.getState(), useSubscriptionStore.setState()). No @testing-library/react needed for store tests.
    </standards>
    <locations>
      apps/mobile/src/**/__tests__/*.test.ts
      apps/mobile/src/stores/__tests__/subscriptionStore.test.ts (existing, 15 tests)
    </locations>
    <ideas>
      <idea ac="1">Test subscription screen shows correct tier label (Free/Pro Monthly/Pro Annual)</idea>
      <idea ac="1">Test subscription screen shows renewal date for Pro users</idea>
      <idea ac="1">Test subscription screen shows days remaining calculation</idea>
      <idea ac="2">Test getManagementUrl returns correct URL for iOS</idea>
      <idea ac="2">Test getManagementUrl returns correct URL for Android</idea>
      <idea ac="3">Test subscription screen shows upgrade prompt for Free users</idea>
      <idea ac="4">Test Accounts screen displays subscription tier</idea>
      <idea ac="4">Test navigation from Accounts to subscription screen</idea>
    </ideas>
  </tests>
</story-context>
