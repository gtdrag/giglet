<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>10</epicId>
    <storyId>2</storyId>
    <title>Tip Location Storage Backend</title>
    <status>ready-for-dev</status>
    <generatedAt>2026-01-06</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>.bmad-ephemeral/stories/10-2-tip-location-storage-backend.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>system</asA>
    <iWant>to provide query endpoints for tip location data</iWant>
    <soThat>drivers can retrieve and filter their personal tip database</soThat>
    <tasks>
      <task id="1" ac="1,5">Create GET /api/v1/tips Endpoint - Add GET handler to tips.routes.ts, query TipLog by userId, implement pagination (limit/offset with defaults), return total count</task>
      <task id="2" ac="2">Add TipSize Filter - Accept optional tipSize query param, filter tips where tipSize >= specified size (hierarchical), validate tipSize enum value</task>
      <task id="3" ac="3">Add Date Range Filter - Accept optional startDate and endDate query params, filter createdAt between dates (inclusive), validate date format (ISO 8601)</task>
      <task id="4" ac="4">Add Viewport Bounds Filter - Accept optional minLat, maxLat, minLng, maxLng query params, filter tips within coordinate bounds, validate coordinate ranges</task>
      <task id="5" ac="1-5">Create Mobile Tips Query Service - Add getTips() function to src/services/tips.ts, accept filter options object, return typed response with tips array and pagination info</task>
      <task id="6" ac="1-5">Add Unit Tests - Backend tests for GET /tips, tipSize filter, date range filter, viewport bounds filter, pagination; Mobile test for getTips service</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">Given a driver has logged tips, When they request their tips via GET /api/v1/tips, Then they receive their tip records with: id, lat, lng, tipSize, createdAt</criterion>
    <criterion id="2">Given a driver queries their tips, When they include a tipSize filter (?tipSize=LARGE), Then only tips matching that size or larger are returned</criterion>
    <criterion id="3">Given a driver queries their tips, When they include date range filters (?startDate=...&amp;endDate=...), Then only tips within that range are returned</criterion>
    <criterion id="4">Given a driver queries tips for a map viewport, When they include bounds (?minLat=...&amp;maxLat=...&amp;minLng=...&amp;maxLng=...), Then only tips within those coordinates are returned</criterion>
    <criterion id="5">Given a driver has many tips, When they query without filters, Then results are paginated (limit/offset) with total count</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Story 10.2: Tip Location Storage Backend</section>
        <snippet>New TipLog table with id, userId, lat, lng, tipSize enum, createdAt. Index on userId for fast queries. Spatial index on lat/lng for viewport queries.</snippet>
      </doc>
      <doc>
        <path>.bmad-ephemeral/stories/10-1-tip-logging-button-and-ui.md</path>
        <title>Story 10.1 - Predecessor</title>
        <section>Dev Agent Record - File List</section>
        <snippet>Created tips.routes.ts, tips.controller.ts, tips.service.ts, tips.schema.ts. TipLog model and TipSize enum added to Prisma schema with spatial indexes.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>apps/api/src/routes/tips.routes.ts</path>
        <kind>route</kind>
        <symbol>router</symbol>
        <lines>1-27</lines>
        <reason>EXTEND: Add GET / handler alongside existing POST. Already has requireAuth middleware applied.</reason>
      </artifact>
      <artifact>
        <path>apps/api/src/services/tips.service.ts</path>
        <kind>service</kind>
        <symbol>TipsService</symbol>
        <lines>11-42</lines>
        <reason>EXTEND: Add queryTips method to TipsService class. Follow createTipLog pattern for structure.</reason>
      </artifact>
      <artifact>
        <path>apps/api/src/schemas/tips.schema.ts</path>
        <kind>schema</kind>
        <symbol>TipSizeSchema, CreateTipLogSchema</symbol>
        <lines>1-14</lines>
        <reason>EXTEND: Add GetTipsQuerySchema with tipSize, startDate, endDate, minLat, maxLat, minLng, maxLng, limit, offset params.</reason>
      </artifact>
      <artifact>
        <path>apps/api/src/controllers/tips.controller.ts</path>
        <kind>controller</kind>
        <symbol>TipsController</symbol>
        <reason>EXTEND: Add getTips handler method to controller class.</reason>
      </artifact>
      <artifact>
        <path>apps/mobile/src/services/tips.ts</path>
        <kind>service</kind>
        <symbol>logTip, TipLog, TipSize</symbol>
        <lines>1-62</lines>
        <reason>EXTEND: Add getTips() function. Reuse existing TipLog and TipSize types.</reason>
      </artifact>
      <artifact>
        <path>apps/api/src/schemas/earnings.schema.ts</path>
        <kind>schema</kind>
        <symbol>GetDeliveriesSchema</symbol>
        <lines>31-39</lines>
        <reason>REFERENCE: Pattern for pagination params (limit, offset with z.coerce.number)</reason>
      </artifact>
      <artifact>
        <path>apps/api/src/services/earnings.service.ts</path>
        <kind>service</kind>
        <symbol>getEarningsSummary</symbol>
        <lines>35-68</lines>
        <reason>REFERENCE: Pattern for date range filtering with Prisma (gte, lt)</reason>
      </artifact>
      <artifact>
        <path>apps/api/prisma/schema.prisma</path>
        <kind>schema</kind>
        <symbol>TipLog, TipSize</symbol>
        <lines>252-263</lines>
        <reason>REFERENCE: TipLog model with userId, lat, lng, tipSize, createdAt. Has @@index([userId]) and @@index([lat, lng])</reason>
      </artifact>
    </code>

    <dependencies>
      <node>
        <package>@prisma/client</package>
        <version>^6.9.0</version>
        <use>TipSize enum, TipLog model, Prisma queries</use>
      </node>
      <node>
        <package>zod</package>
        <version>^3.24.2</version>
        <use>Schema validation for query params</use>
      </node>
      <node>
        <package>express</package>
        <version>^4.21.2</version>
        <use>Router, Request, Response types</use>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Follow existing route/controller/service pattern from earnings and tips modules</constraint>
    <constraint>Use Zod for all query parameter validation with z.coerce for numbers</constraint>
    <constraint>TipSize hierarchy: NONE &lt; SMALL &lt; MEDIUM &lt; LARGE &lt; XLARGE &lt; XXLARGE - filter returns specified size AND ABOVE</constraint>
    <constraint>Pagination defaults: limit=50, max=100; offset default=0</constraint>
    <constraint>Date validation: ISO 8601 format, startDate must be before endDate</constraint>
    <constraint>Coordinate validation: lat -90 to 90, lng -180 to 180</constraint>
    <constraint>All query params optional - default returns all user's tips (paginated)</constraint>
    <constraint>Use existing spatial index on lat/lng for viewport queries</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>GET /api/v1/tips</name>
      <kind>REST endpoint</kind>
      <signature>GET /api/v1/tips?tipSize=LARGE&amp;startDate=2026-01-01&amp;endDate=2026-01-31&amp;minLat=34.0&amp;maxLat=34.1&amp;minLng=-118.5&amp;maxLng=-118.4&amp;limit=50&amp;offset=0</signature>
      <path>apps/api/src/routes/tips.routes.ts</path>
    </interface>
    <interface>
      <name>queryTips</name>
      <kind>service method</kind>
      <signature>async queryTips(userId: string, filters: QueryTipsFilters): Promise&lt;{ tips: TipLog[], pagination: Pagination }&gt;</signature>
      <path>apps/api/src/services/tips.service.ts</path>
    </interface>
    <interface>
      <name>getTips</name>
      <kind>mobile service</kind>
      <signature>async getTips(filters?: GetTipsFilters): Promise&lt;{ tips: TipLog[], pagination: Pagination }&gt;</signature>
      <path>apps/mobile/src/services/tips.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Use Vitest with vi.hoisted() pattern for proper mock setup. Mock Prisma client. Follow existing test patterns in tips.service.test.ts and delivery.service.test.ts.</standards>
    <locations>
      <location>apps/api/src/services/__tests__/tips.service.test.ts</location>
      <location>apps/mobile/src/services/__tests__/tips.test.ts</location>
    </locations>
    <ideas>
      <idea ac="1">Test GET /tips returns only authenticated user's tips, not other users' tips</idea>
      <idea ac="2">Test tipSize=LARGE returns LARGE, XLARGE, XXLARGE but not NONE, SMALL, MEDIUM</idea>
      <idea ac="2">Test tipSize=NONE returns all tips (no filtering)</idea>
      <idea ac="3">Test date range filter returns only tips within specified dates</idea>
      <idea ac="3">Test startDate without endDate still works (open-ended range)</idea>
      <idea ac="4">Test viewport bounds correctly filters by lat/lng range</idea>
      <idea ac="4">Test coordinate validation rejects invalid ranges</idea>
      <idea ac="5">Test default pagination returns first 50 results with total count</idea>
      <idea ac="5">Test offset=50 returns next page of results</idea>
      <idea ac="5">Test limit=0 or negative is rejected</idea>
    </ideas>
  </tests>
</story-context>
